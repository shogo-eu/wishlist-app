# 機能要件（Functional Requirements）

本ドキュメントでは、Wishlist App（variant）の  
**v1 における機能要件**を定義する。

設計・実装・テストは本ドキュメントを正とし、  
不明点が出た場合は本要件に立ち返って判断する。

---

## 1. 対象機能一覧

### 1-1. お気に入り管理（variant単位）
- お気に入り追加
- お気に入り解除
- お気に入り状態の表示

### 1-2. ユーザー区分対応
- ゲストユーザー対応
- ログインユーザー対応
- ゲスト → ログインの引き継ぎ

### 1-3. 表示・画面連携
- 商品詳細ページ（PDP）
- お気に入り一覧ページ

---

## 2. お気に入り管理（variant）

### 2-1. 追加
- ユーザーは **variant単位**でお気に入りを追加できる
- 追加操作はトグル式とし、再操作で解除できる

#### 振る舞い
| 状態 | 操作 | 結果 |
|---|---|---|
| 未保存 | クリック | お気に入り追加 |
| 保存済 | クリック | お気に入り解除 |

---

### 2-2. 表示状態
- 現在選択中のvariantに対して、
  - 保存済：ハートON（active）
  - 未保存：ハートOFF
- variant切替時は即座に状態を再評価する

---

### 2-3. 保存単位
- 保存の主キーは `variant_id`
- 表示・復元用途として `product_id` を併記する
- 同一 `variant_id` の重複保存は禁止

---

## 3. ゲストユーザー要件

### 3-1. 対応範囲
- ゲストユーザーは以下を利用できる
  - お気に入り追加/解除
  - お気に入り一覧表示（All）

### 3-2. 保存方式
- 保存先は **localStorage**
- JSON形式で保存する
- ブラウザ/端末単位で管理される

### 3-3. 制限事項
- 分類・整理機能は提供しない

---

## 4. ログインユーザー要件

### 4-1. 対応範囲
- ログインユーザーは以下を利用できる
  - お気に入り追加/解除
  - お気に入り一覧表示

### 4-2. 保存方式
- 保存先は **Customer metafield**
- items / collections / 分類情報をJSONで管理する

---

## 5. ゲスト → ログイン引き継ぎ

### 5-1. 実行タイミング
- ログイン後、以下いずれかのタイミングで実行する
  - お気に入りページ初回表示時
  - マイページ初回表示時

### 5-2. 引き継ぎルール
- ゲストの `items` とログイン側 `items` を **和集合** でマージ
- 重複（variant_id）は1件にまとめる
- 引き継がれたアイテムは **未分類** とする

### 5-3. 引き継ぎ後
- 引き継ぎ成功後、localStorageのデータはクリアする
- 以降はログイン側のデータを正とする

---

## 6. お気に入り一覧ページ

### 6-1. ゲスト
- 表示対象：All（全お気に入り）
- コレクションUIは表示しない
- ログイン誘導文言を表示する

---

### 6-2. ログイン
- 表示対象：
  - All
  - 未分類
  - ユーザー作成コレクション
- コレクション切替により表示アイテムを絞り込む

---
## 7. 共有機能（LINE等）

### 7-1. 目的
ユーザーが検討中の商品（variant）を第三者に共有できるようにする。
例：LINEで家族・チームメンバーに共有し、購入相談・合意形成を促進する。

### 7-2. 共有対象
- 共有単位は **variant** とする
- 共有リンクには最低限以下の情報を含める
  - productページへの遷移（variant指定付き）
  - 共有元情報（任意：ストア名、簡易メッセージ）

### 7-3. 共有可能商品の制限（必須要件）
すべての商品が共有できると運用上まずいため、共有可否は **商品側のフラグで制御**する。

- 共有「許可」されている商品だけ共有UIを表示する
- 共有「禁止」の商品では共有UIを表示しない（または押下不可）

共有可否の判定方法（いずれか1つを採用）：
- 商品タグ：`SHARE_OK`（例）
- 商品メタフィールド：`custom.share_enabled = true`（例）

※v1では実装簡易性の観点から「タグ」優先でもよいが、運用性を重視する場合はメタフィールド推奨。

### 7-4. 共有UI（画面要件）
- 商品詳細（PDP）：
  - 共有可の商品に限り「LINEで共有」「リンクをコピー」等を表示する
  - variant選択に応じて共有内容（URL）が切り替わる
- お気に入り一覧ページ：
  - アイテムごとに共有ボタンを表示（共有可商品のみ）
  - ゲスト/ログイン問わず利用可能

### 7-5. 共有方法（最低限）
v1では以下のいずれか（または両方）を提供する：
- LINE共有（`https://social-plugins.line.me/lineit/share?url=...` 形式）
- リンクコピー（クリップボードへコピー）

### 7-6. 共有URL仕様
- 基本は商品詳細ページのURLを用いる
- variant指定はクエリで表現する（例：`?variant=XXXXXXXX`）
- 共有可否が false の商品は、共有URL生成を行わない

### 7-7. セキュリティ / 機密配慮
- 共有URLに、ユーザーの個人情報（customer_id、wishlist内容等）を含めない
- 共有可否の判定はテーマ側（Liquid/JS）で行い、UI表示を抑制する
  - （必要に応じてサーバー側でも共有可否を再チェックできる設計を検討）

## 8. エラーハンドリング（機能観点）

### 8-1. 通信エラー（ログイン時）
- API失敗時は以下を行う
  - UI状態を元に戻す
  - ユーザーにエラーメッセージを表示

### 8-2. データ不整合
- 削除済みvariantが含まれている場合
  - 表示時に除外する
  - 必要に応じてクレンジング対象とする

---

## 9. 非対象（明示）
以下は v1 の機能要件に **含めない**

- お気に入り数の分析・集計
- 管理画面での操作UI
- 未ログイン状態でのコレクション利用
- 他ユーザーとの共有機能
- 通知・レコメンド連携

---

## 10. 受け入れ条件（Acceptance Criteria / v1）

- variant単位でお気に入りが正しく管理される
- ゲスト・ログインで体験が破綻しない
- ログイン後の引き継ぎでデータ欠損が起きない
- コレクション操作が直感的に行える
- 要件外の機能が実装に混入していない
